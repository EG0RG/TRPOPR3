<?xml version="1.0" encoding="UTF-8"?><sqlb_project><db path="car_rental.db" readonly="0" foreign_keys="1" case_sensitive_like="0" temp_store="0" wal_autocheckpoint="1000" synchronous="2"/><attached/><window><main_tabs open="structure browser pragmas query" current="1"/></window><tab_structure><column_width id="0" width="300"/><column_width id="1" width="0"/><column_width id="2" width="100"/><column_width id="3" width="2776"/><column_width id="4" width="0"/><expanded_item id="0" parent="1"/><expanded_item id="1" parent="1"/><expanded_item id="2" parent="1"/><expanded_item id="3" parent="1"/></tab_structure><tab_browse><table title="cars" custom_title="0" dock_id="4" table="4,4:maincars"/><table title="bookings" custom_title="0" dock_id="1" table="4,8:mainbookings"/><table title="bookings" custom_title="0" dock_id="5" table="4,8:mainbookings"/><table title="cars" custom_title="0" dock_id="6" table="4,4:maincars"/><dock_state state="000000ff00000000fd0000000100000002000003e1000002e6fc0100000001fc00000000000003e10000012800fffffffa000000030100000004fb000000160064006f0063006b00420072006f00770073006500310100000000ffffffff0000012800fffffffb000000160064006f0063006b00420072006f00770073006500340100000000ffffffff0000012800fffffffb000000160064006f0063006b00420072006f00770073006500350100000000ffffffff0000012800fffffffb000000160064006f0063006b00420072006f00770073006500360100000000ffffffff0000012800ffffff000003e10000000000000004000000040000000800000008fc00000000"/><default_encoding codec=""/><browse_table_settings><table schema="main" name="bookings" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="29"/><column index="2" value="77"/><column index="3" value="80"/><column index="4" value="76"/><column index="5" value="45"/><column index="6" value="66"/><column index="7" value="61"/><column index="8" value="43"/><column index="9" value="112"/><column index="10" value="128"/><column index="11" value="82"/><column index="12" value="67"/><column index="13" value="68"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="cars" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="29"/><column index="2" value="140"/><column index="3" value="55"/><column index="4" value="82"/><column index="5" value="39"/><column index="6" value="93"/><column index="7" value="257"/><column index="8" value="69"/><column index="9" value="58"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table></browse_table_settings></tab_browse><tab_sql><sql name="SQL 1">-- Создание базы данных для системы автопроката

-- Таблица классов автомобилей
CREATE TABLE IF NOT EXISTS car_classes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT UNIQUE NOT NULL,
    daily_price DECIMAL(10,2) NOT NULL,
    description TEXT
);

-- Таблица автомобилей
CREATE TABLE IF NOT EXISTS cars (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    model TEXT NOT NULL,
    car_class_id INTEGER NOT NULL,
    license_plate TEXT UNIQUE NOT NULL,
    year INTEGER,
    color TEXT,
    features TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (car_class_id) REFERENCES car_classes (id)
);

-- Таблица клиентов
CREATE TABLE IF NOT EXISTS clients (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    full_name TEXT NOT NULL,
    phone TEXT NOT NULL,
    email TEXT,
    passport_data TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Таблица бронирований
CREATE TABLE IF NOT EXISTS bookings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    client_id INTEGER NOT NULL,
    car_id INTEGER NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    total_price DECIMAL(10,2) NOT NULL,
    status TEXT DEFAULT 'pending', -- pending, confirmed, cancelled, completed
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (client_id) REFERENCES clients (id),
    FOREIGN KEY (car_id) REFERENCES cars (id)
);

-- Вставка данных классов автомобилей
INSERT OR IGNORE INTO car_classes (name, daily_price, description) VALUES
('economy', 1500.00, 'Бюджетные автомобили для городской езды'),
('comfort', 2500.00, 'Комфортабельные седаны для поездок'),
('business', 5000.00, 'Премиальные автомобили для бизнеса'),
('suv', 4000.00, 'Внедорожники для путешествий');

-- Вставка данных автомобилей
INSERT OR IGNORE INTO cars (model, car_class_id, license_plate, year, color, features) VALUES
-- Эконом класс
('Toyota Corolla', 1, 'А123ВС777', 2022, 'Белый', 'Кондиционер, Bluetooth, мультимедиа'),
('Hyundai Solaris', 1, 'В456ОР777', 2021, 'Серый', 'Кондиционер, парктроник'),
('Kia Rio', 1, 'С789ТХ777', 2023, 'Красный', 'Климат-контроль, камера заднего вида'),

-- Комфорт класс
('Volkswagen Passat', 2, 'Е321КХ777', 2022, 'Черный', 'Кожаный салон, подогрев сидений'),
('Skoda Octavia', 2, 'М654АВ777', 2023, 'Синий', 'Панорамная крыша, ксенон'),
('Toyota Camry', 2, 'Н987УС777', 2022, 'Белый', 'Кожа, климат-контроль, память сидений'),

-- Бизнес класс
('Mercedes E-Class', 3, 'О159РВ777', 2023, 'Черный', 'Память сидений, массаж, премиум аудио'),
('BMW 5 Series', 3, 'Р753АК777', 2022, 'Серый', 'Парктроник, камера 360, проекционный дисплей'),
('Audi A6', 3, 'Т246СМ777', 2023, 'Синий', 'Полный привод, премиум аудио, кожаный салон'),

-- Внедорожники
('Toyota RAV4', 4, 'У369ФН777', 2022, 'Белый', 'Полный привод, круиз-контроль, климат-контроль'),
('Honda CR-V', 4, 'Х582ЛО777', 2023, 'Красный', 'Парктроник, камера, подогрев руля'),
('Nissan X-Trail', 4, 'Ф714ПР777', 2022, 'Черный', 'Климат-контроль, подогрев руля и сидений');

-- Вставка тестовых клиентов
INSERT OR IGNORE INTO clients (full_name, phone, email, passport_data) VALUES
('Иванов Иван Иванович', '+7-911-123-45-67', 'ivanov@mail.ru', '4510 123456'),
('Петров Петр Петрович', '+7-912-234-56-78', 'petrov@gmail.com', '4510 234567'),
('Сидорова Анна Сергеевна', '+7-913-345-67-89', 'sidorova@yandex.ru', '4510 345678'),
('Козлов Дмитрий Владимирович', '+7-914-456-78-90', 'kozlov@mail.ru', '4510 456789');

-- Вставка тестовых бронирований
INSERT OR IGNORE INTO bookings (client_id, car_id, start_date, end_date, total_price, status) VALUES
(1, 1, '2024-03-01', '2024-03-05', 6000.00, 'completed'),
(2, 5, '2024-03-10', '2024-03-12', 5000.00, 'confirmed'),
(3, 8, '2024-03-15', '2024-03-20', 25000.00, 'confirmed'),
(4, 11, '2024-03-25', '2024-03-28', 12000.00, 'pending');

-- Создание индексов для улучшения производительности
CREATE INDEX IF NOT EXISTS idx_bookings_dates ON bookings (start_date, end_date);
CREATE INDEX IF NOT EXISTS idx_bookings_status ON bookings (status);
CREATE INDEX IF NOT EXISTS idx_cars_class ON cars (car_class_id);
CREATE INDEX IF NOT EXISTS idx_cars_active ON cars (is_active);

-- Представления для удобства работы

-- Представление для просмотра всех автомобилей с информацией о классе
CREATE VIEW IF NOT EXISTS cars_with_classes AS
SELECT 
    c.id,
    c.model,
    c.license_plate,
    c.year,
    c.color,
    c.features,
    c.is_active,
    cc.name as class_name,
    cc.daily_price,
    cc.description as class_description
FROM cars c
JOIN car_classes cc ON c.car_class_id = cc.id;

-- Представление для просмотра бронирований с полной информацией
CREATE VIEW IF NOT EXISTS booking_details AS
SELECT 
    b.id as booking_id,
    b.start_date,
    b.end_date,
    b.total_price,
    b.status,
    b.created_at,
    cl.full_name as client_name,
    cl.phone as client_phone,
    cl.email as client_email,
    c.model as car_model,
    c.license_plate,
    cc.name as car_class,
    cc.daily_price
FROM bookings b
JOIN clients cl ON b.client_id = cl.id
JOIN cars c ON b.car_id = c.id
JOIN car_classes cc ON c.car_class_id = cc.id;

-- Представление для проверки доступности автомобилей
CREATE VIEW IF NOT EXISTS car_availability AS
SELECT 
    c.id as car_id,
    c.model,
    c.license_plate,
    cc.name as class_name,
    cc.daily_price,
    CASE 
        WHEN EXISTS (
            SELECT 1 FROM bookings b 
            WHERE b.car_id = c.id 
            AND b.status = 'confirmed'
            AND date('now') BETWEEN b.start_date AND b.end_date
        ) THEN 'occupied'
        ELSE 'available'
    END as current_status
FROM cars c
JOIN car_classes cc ON c.car_class_id = cc.id
WHERE c.is_active = TRUE;</sql><current_tab id="0"/></tab_sql></sqlb_project>
